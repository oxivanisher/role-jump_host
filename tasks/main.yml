---

- name: Update apt package cache
  become: true
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 86400

- name: "Add jump user {{ jump_host.user_name }}"
  ansible.builtin.user:
    name: "{{ jump_host.user_name }}"
    comment: "{{ jump_host.user_comment }}"
    group: "{{ jump_host.user_group }}"
    groups: "{{ jump_host.user_groups | join(',') }}"
    createhome: true

- name: Ensure ansible repo  # noqa git-latest
  ansible.builtin.git:
    repo: "{{ jump_host.ansible_repo }}"
    dest: "/home/{{ jump_host.user_name }}/ansible"
    accept_hostkey: true
  become_user: "{{ jump_host.user_name }}"

- name: Ensure jumphost specifig packages
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop:
    - tmux
    - python3
    - python3-pip
    - fonts-powerline
    - dnsutils
    - pwgen
    - nmap
    - xclip

- name: Install powerline-status
  ansible.builtin.pip:
    name: ['powerline-status', 'powerline-gitstatus']
    executable: pip3

- name: "Configure port 22 for sshd"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "Port 22"
    line: "Port 22"
  notify: Restart sshd

- name: "Configure additional sshd port {{ jump_host.ssh_port }}"
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^Port {{ jump_host.ssh_port }}"
    line: "Port {{ jump_host.ssh_port }}"
    insertafter: "^Port 22"
  notify: Restart sshd

# TODO
# * remember install longview
# * evtl. skeeve mount? lieber plex
# * As user oxi after sync: python .nextrsync/Settings/Linux/setup.py
